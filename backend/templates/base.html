{% load static %}
<!doctype html>
<html lang="ru">
<head>
  <link rel="icon"
      type="image/svg+xml"
      href="{% static 'images/VidiumLogo.svg' %}">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>VIDIUM</title>
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/calendar.css' %}">
</head>
<body>
  <header class="topbar">
    <div class="container topbar-inner">

<a href="{% url 'calendar' %}" class="nav-logo">
    <img src="{% static 'images/VidiumLogo.svg' %}"
         alt="Vidium"
         class="logo-img">
</a>

      {% if user.is_authenticated %}
        <nav class="nav">
          <a class="nav-link" href="{% url 'calendar' %}">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
          <a class="nav-link" href="{% url 'event_list' %}">üóì –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a>


          {% if can_view_stock %}
            <a class="nav-link" href="{% url 'stock_type_list' %}">üì¶ –°–∫–ª–∞–¥</a>
          {% endif %}


          {% if can_manage_staff %}
            <a class="nav-link" href="{% url 'personnel' %}">üë• –ü–µ—Ä—Å–æ–Ω–∞–ª</a>
            <a class="nav-link" href="{% url 'audit_list' %}">üìí –ñ—É—Ä–Ω–∞–ª</a>
          {% endif %}
          
          <div class="notif-wrap">
            <button type="button" class="nav-link notif-bell" id="notifBell" aria-label="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
              üîî
              <span class="notif-dot{% if notifications_unread_count|default:0 > 0 %} is-on{% endif %}" id="notifDot"></span>
            </button>

            <div class="notif-panel" id="notifPanel" aria-hidden="true">
              <div class="notif-head">
                <div class="notif-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                <div class="notif-actions">
                  <button type="button" class="notif-link" id="notifMarkAll">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ</button>
                  <button type="button" class="notif-link" id="notifClose">‚úï</button>
                </div>
              </div>
              <div class="notif-body" id="notifBody">
                <div class="notif-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
              </div>
            </div>
          </div>

          <a class="nav-link" href="{% url 'cabinet:dashboard' %}">‚öôÔ∏è –ö–∞–±–∏–Ω–µ—Ç</a>
          <form method="post" action="{% url 'logout' %}" style="display:inline;">
  {% csrf_token %}
  <button type="submit" class="nav-link" style="background:none;border:none;padding:0;cursor:pointer;">
    üö™ –í—ã–π—Ç–∏
  </button>
</form>
          {% if user.is_superuser %}
            <a class="nav-link" href="/admin/">‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞</a>
          {% endif %}
        </nav>
      {% endif %}
    </div>
  </header>

  <main class="container" style="padding-top: 18px;">
    {% if messages %}
      <div style="margin-bottom:14px;">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    {% block content %}{% endblock %}
  </main>

<script>
(function(){
  const bell = document.getElementById("notifBell");
  const panel = document.getElementById("notifPanel");
  const body = document.getElementById("notifBody");
  const dot = document.getElementById("notifDot");
  const closeBtn = document.getElementById("notifClose");
  const markAllBtn = document.getElementById("notifMarkAll");

  if(!bell || !panel || !body || !dot) return;

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return "";
  }
  const csrftoken = getCookie("csrftoken");

  async function fetchList(){
    body.innerHTML = '<div class="notif-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
    try{
      const resp = await fetch("/notifications/api/list/", {credentials: "same-origin"});
      const data = await resp.json();
      if(!data.ok){
        body.innerHTML = '<div class="notif-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        return;
      }
      if(data.unread_count > 0){
        dot.classList.add("is-on");
      }else{
        dot.classList.remove("is-on");
      }
      renderItems(data.items || []);
    }catch(e){
      body.innerHTML = '<div class="notif-empty">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>';
    }
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[c]));
  }

  function renderItems(items){
    if(!items.length){
      body.innerHTML = '<div class="notif-empty">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
      return;
    }
    const html = items.map(it=>{
      const cls = it.is_read ? "notif-item" : "notif-item unread";
      const title = escapeHtml(it.title);
      const msg = escapeHtml(it.message || "");
      const url = it.url || "";
      const open = url ? `<a class="notif-open" href="${escapeHtml(url)}">–û—Ç–∫—Ä—ã—Ç—å</a>` : "";
      return `
        <div class="${cls}" data-id="${it.id}">
          <div class="notif-item-top">
            <div class="notif-item-title">${title}</div>
            <button type="button" class="notif-del" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
          </div>
          ${msg ? `<div class="notif-item-msg">${msg}</div>` : ""}
          <div class="notif-item-actions">
            <button type="button" class="notif-mark">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ</button>
            ${open}
          </div>
        </div>
      `;
    }).join("");
    body.innerHTML = html;

    body.querySelectorAll(".notif-mark").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        const item = e.target.closest(".notif-item");
        const id = item.getAttribute("data-id");
        await fetch(`/notifications/api/mark-read/${id}/`, {
          method:"POST",
          headers: {"X-CSRFToken": csrftoken},
          credentials:"same-origin"
        });
        item.classList.remove("unread");
        fetchList();
      });
    });

    body.querySelectorAll(".notif-del").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        const item = e.target.closest(".notif-item");
        const id = item.getAttribute("data-id");
        await fetch(`/notifications/api/delete/${id}/`, {
          method:"POST",
          headers: {"X-CSRFToken": csrftoken},
          credentials:"same-origin"
        });
        fetchList();
      });
    });
  }

  function openPanel(){
    panel.style.display = "block";
    panel.setAttribute("aria-hidden", "false");
    fetchList();
  }
  function closePanel(){
    panel.style.display = "none";
    panel.setAttribute("aria-hidden", "true");
  }
  function isOpen(){
    return panel.getAttribute("aria-hidden") === "false";
  }

  bell.addEventListener("click", (e)=>{
    e.preventDefault();
    e.stopPropagation();
    if(isOpen()) closePanel();
    else openPanel();
  });

  document.addEventListener("click", (e)=>{
    if(!panel.contains(e.target) && e.target !== bell){
      closePanel();
    }
  });

  if(closeBtn){
    closeBtn.addEventListener("click", (e)=>{
      e.preventDefault();
      closePanel();
    });
  }

  if(markAllBtn){
    markAllBtn.addEventListener("click", async (e)=>{
      e.preventDefault();
      await fetch("/notifications/api/mark-all-read/", {
        method:"POST",
        headers: {"X-CSRFToken": csrftoken},
        credentials:"same-origin"
      });
      fetchList();
    });
  }
})();
</script>

</body>
</html>
