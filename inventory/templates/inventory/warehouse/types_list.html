{% extends "base.html" %}
{% load inventory_extras %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-0">Склад — типы оборудования</h2>
      <div class="text-muted">Планирование и привязка к мероприятиям появятся позже. Сейчас — структура склада.</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'stock_category_list' %}">Категории</a>
      <a class="btn btn-outline-secondary" href="{% url 'stock_repair_list' %}">Ремонт</a>
      {% if can_manage %}
        <a class="btn btn-primary" href="{% url 'stock_type_add' %}">+ Добавить тип</a>
      {% endif %}
    </div>
  </div>

  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <form method="get" class="row g-2 mb-3">
    <div class="col-md-4">
      <input class="form-control" name="q" value="{{ q }}" placeholder="Поиск по названию">
    </div>
    <div class="col-md-3">
      <select class="form-select" name="category" onchange="this.form.submit()">
        <option value="">Категория (все)</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {% if category_id == c.id|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <select class="form-select" name="subcategory" onchange="this.form.submit()">
        <option value="">Подкатегория (все)</option>
        {% for s in subcategories %}
          <option value="{{ s.id }}" {% if subcategory_id == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 d-grid">
      <button class="btn btn-outline-primary" type="submit">Применить</button>
    </div>
  </form>

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th>Категория / Подкатегория</th>
              <th>Название</th>
              <th class="text-center">Всего</th>
              <th class="text-center">На складе</th>
              <th class="text-center">В ремонте</th>
              <th class="text-center">На мероприятии</th>
              <th class="text-end">Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for t in types %}
              {% with cnt=counts_map|get_item:t.id %}
              <tr>
                <td class="text-muted">
                  <div>{{ t.category.name }}</div>
                  <div class="small">{% if t.subcategory %}{{ t.subcategory.name }}{% else %}—{% endif %}</div>
                </td>
                <td>
                  <div class="fw-semibold">{{ t.name }}</div>
                  <div class="text-muted small">
                    {% if t.weight_kg %}Вес: {{ t.weight_kg }} кг{% endif %}
                    {% if t.dimensions_mm %}{% if t.weight_kg %} · {% endif %}Габариты: {{ t.dimensions_mm }}{% endif %}
                    {% if t.power_w %}{% if t.weight_kg or t.dimensions_mm %} · {% endif %}Питание: {{ t.power_w }} W{% endif %}
                  </div>
                </td>
                <td class="text-center">{{ cnt.total|default:0 }}</td>
                <td class="text-center">{{ cnt.on_stock|default:0 }}</td>
                <td class="text-center">{{ cnt.in_repair|default:0 }}</td>
                <td class="text-center">{{ cnt.on_event|default:0 }}</td>
                <td class="text-end">
                  {% if can_manage %}
                    <a class="btn btn-sm btn-outline-secondary" href="{% url 'stock_type_edit' t.id %}">Редактировать</a>
                    <form method="post" action="{% url 'stock_type_delete' t.id %}" style="display:inline;">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-outline-danger" type="submit"
                        onclick="return confirm('Удалить тип «{{ t.name }}»?');">Удалить</button>
                    </form>
                  {% else %}
                    <span class="text-muted small">—</span>
                  {% endif %}
                </td>
              </tr>
              {% endwith %}
            {% empty %}
              <tr><td colspan="7" class="text-muted">Типов оборудования пока нет.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}
