{% extends "base.html" %}

{% block content %}
<h1>{{ title }}</h1>

<form method="post" class="form">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div style="padding:10px; border:1px solid #d33; margin-bottom:12px;">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div class="form-grid">
        <div class="form-row">
            <label>Название</label>
            {{ form.name }}
            {{ form.name.errors }}
        </div>

        <div class="form-row">
            <label>Дата начала</label>
            {{ form.start_date }}
            {{ form.start_date.errors }}
        </div>

        <div class="form-row">
            <label>Дата окончания</label>
            {{ form.end_date }}
            {{ form.end_date.errors }}
        </div>

        <div class="form-row">
            <label>Клиент</label>
            {{ form.client }}
            {{ form.client.errors }}
        </div>

        <div class="form-row">
            <label>Локация</label>
            {{ form.location }}
            {{ form.location.errors }}
        </div>

        <div class="form-row">
            <label>Ответственный</label>
            {{ form.responsible }}
            {{ form.responsible.errors }}
        </div>

        <div class="form-row">
            <label>Старший инженер</label>
            {{ form.s_engineer }}
            {{ form.s_engineer.errors }}
        </div>

        <div class="form-row">
            <label>Инженеры (можно несколько)</label>
            {{ form.engineers }}
            {{ form.engineers.errors }}
            <div style="font-size: 12px; opacity: 0.8; margin-top: 6px;">
              Подсказка: удерживай Ctrl (Windows) / ⌘ (Mac), чтобы выбрать несколько.
            </div>
        </div>

        <div class="form-row">
            <label>Заметки</label>
            {{ form.notes }}
            {{ form.notes.errors }}
        </div>

        <div class="form-row">
            <label>Статус</label>
            {{ form.status }}
            {{ form.status.errors }}
        </div>
    </div>

    <hr style="margin:18px 0;">

    <h2 style="margin:0 0 10px 0;">Дополнительные роли (по необходимости)</h2>

    <div class="card" style="max-width: 980px;">
      <div style="margin-bottom:10px; color:#64748b;">
        Отметь роли, которые нужны именно на этом мероприятии. После выбора появится выбор сотрудников.
      </div>

      <div style="margin-bottom:12px;">
        {{ form.extra_roles.errors }}
        {{ form.extra_roles }}
      </div>

      <div id="extra-role-users">
        {% for role, field in form.extra_role_fields %}
          <div class="extra-role-block" data-role-id="{{ role.id }}" style="display:none; margin-top:12px; padding-top:12px; border-top:1px solid #e5e7eb;">
            <div style="font-weight:800; margin-bottom:6px;">{{ role.name }}</div>
            <div>
              {{ field }}
              {{ field.errors }}
              <div style="font-size: 12px; opacity: 0.8; margin-top: 6px;">
                Выбери одного или нескольких сотрудников (Ctrl/⌘ для множественного выбора).
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div style="margin-top:16px;">
        <button class="btn" type="submit">Сохранить</button>
        <a class="btn-secondary" href="{% url 'calendar' %}{% if request.GET.year and request.GET.month %}?year={{ request.GET.year }}&month={{ request.GET.month }}{% endif %}">Отмена</a>
    </div>
</form>

<script>
(function() {
  function selectedRoleIds() {
    const boxes = document.querySelectorAll('input[name="extra_roles"]');
    const ids = [];
    boxes.forEach(b => { if (b.checked) ids.push(b.value); });
    return new Set(ids);
  }

  function updateBlocks() {
    const selected = selectedRoleIds();
    document.querySelectorAll('.extra-role-block').forEach(block => {
      const rid = block.getAttribute('data-role-id');
      block.style.display = selected.has(rid) ? 'block' : 'none';
    });
  }

  document.addEventListener('change', function(e) {
    if (e.target && e.target.name === 'extra_roles') updateBlocks();
  });

  updateBlocks();
})();
</script>

{% endblock %}