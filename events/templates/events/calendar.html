{% extends "base.html" %}
{% load event_extras %}

{% block content %}

{% now "Y-m-d" as today_str %}

<style>
  .cal-wrap{
    background:#ffffff;
    border:1px solid #e5e7eb;
    border-radius:12px;
    overflow:hidden;
  }

  .cal-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    margin-bottom:16px;
  }

  .cal-weekdays{
    display:grid;
    grid-template-columns:repeat(7, 1fr);
    background:#f9fafb;
    border-bottom:1px solid #eef2f7;
  }
  .cal-weekdays div{
    padding:10px 12px;
    font-size:13px;
    color:#374151;
    font-weight:700;
    border-right:1px solid #eef2f7;
  }
  .cal-weekdays div:last-child{ border-right:0; }

  .cal-week{
    position:relative;
    display:grid;
    grid-template-columns:repeat(7, 1fr);
    border-bottom:1px solid #eef2f7;
    --lanes: 3;
  }
  .cal-week:last-child{ border-bottom:0; }

  .cal-day{
    min-height:120px;
    padding:8px;
    border-right:1px solid #eef2f7;
    position:relative;
    cursor:pointer;
    background:#ffffff;
  }
  .cal-day:last-child{ border-right:0; }

  .cal-day.other-month{
    background:#fafafa;
    color:#9ca3af;
    cursor:default;
    opacity:0.70;
  }
  .cal-day:hover{ background:rgba(0,0,0,.02); }
  .cal-day.other-month:hover{ background:#fafafa; }

  .cal-day.today{
    background: rgba(59,130,246,0.04);
    outline: 2px solid rgba(59,130,246,0.35);
    outline-offset: -2px;
  }

  .cal-day-number{
    font-weight:700;
    font-size:12px;
    color:#374151;
    margin-bottom:6px;
    user-select:none;
  }

  .cal-bars{
    position:absolute;
    left:0; right:0;
    top:26px;
    height: calc(12px + (var(--lanes) * 26px));
    pointer-events:none;
    overflow:hidden;
  }

  .event-bar{
    position:absolute;
    height:22px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0 10px;
    font-size:12px;
    line-height:1;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    border:1px solid transparent;
    box-sizing:border-box;
    border-radius:999px;
    pointer-events:auto;
    user-select:none;

    left: calc(var(--start) * (100% / 7));
    width: calc(var(--span) * (100% / 7));
    top: calc(6px + (var(--lane) * 26px));

    transition: filter 140ms ease, box-shadow 140ms ease, transform 140ms ease;
  }

  .event-bar a{
    color:inherit;
    text-decoration:none;
    width:100%;
    text-align:center;
    display:block;
  }

  .event-bar:hover{
    filter: brightness(0.97);
    box-shadow: 0 6px 14px rgba(0,0,0,0.14);
    transform: translateY(-1px);
    z-index:5;
  }

  .event-bar.cont-left{
    border-top-left-radius:6px;
    border-bottom-left-radius:6px;
  }
  .event-bar.cont-right{
    border-top-right-radius:6px;
    border-bottom-right-radius:6px;
  }

  .event-bar[draggable="true"]{ cursor:grab; }
  .event-bar.dragging{ opacity:.5; }

  .event-bar.status-draft{
    background: rgba(255, 215, 0, .35);
    border-color: rgba(255, 215, 0, .55);
    color:#2a2a2a;
  }
  .event-bar.status-confirmed{
    background: rgba(40, 167, 69, .20);
    border-color: rgba(40, 167, 69, .35);
    color:#1f3b25;
  }
  .event-bar.status-cancelled{
    background: rgba(220, 53, 69, .20);
    border-color: rgba(220, 53, 69, .35);
    color:#4a1c20;
  }
  .event-bar.status-closed{
    background: rgba(33, 37, 41, .18);
    border-color: rgba(33, 37, 41, .28);
    color:#1f2327;
  }

  .event-bar.has-problem{
    outline:2px solid rgba(0,0,0,0.35);
    outline-offset:1px;
  }

  .cal-day.drop-hover{
    outline:2px dashed rgba(0,0,0,.25);
    outline-offset:-4px;
  }

  /* ===== Modals ===== */
  .cal-modal-backdrop{
    position:fixed; inset:0;
    background:rgba(0,0,0,.45);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
    padding:16px;
  }
  .cal-modal{
    background:#fff;
    border-radius:16px;
    width:min(560px, 100%);
    box-shadow:0 18px 50px rgba(0,0,0,.25);
    overflow:hidden;
  }
  .cal-modal__head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:14px 16px;
    border-bottom:1px solid rgba(0,0,0,.08);
  }
  .cal-modal__title{
    font-size:16px;
    font-weight:700;
    margin:0;
  }
  .cal-modal__close{
    border:0;
    background:transparent;
    font-size:18px;
    cursor:pointer;
    padding:6px 10px;
    border-radius:10px;
  }
  .cal-modal__close:hover{ background:rgba(0,0,0,.06); }
  .cal-modal__body{ padding:16px; }
  .cal-modal__row{
    display:flex;
    gap:12px;
    align-items:center;
    margin-top:10px;
  }
  .cal-modal__row label{ min-width:120px; }
  .cal-modal__row input, .cal-modal__row select{
    width:100%;
    padding:10px 12px;
    border:1px solid rgba(0,0,0,.15);
    border-radius:10px;
    outline:none;
  }
  .cal-modal__row input:focus, .cal-modal__row select:focus{ border-color:rgba(0,0,0,.35); }
  .cal-modal__actions{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    padding:14px 16px;
    border-top:1px solid rgba(0,0,0,.08);
    background:rgba(0,0,0,.02);
    flex-wrap:wrap;
  }
  .cal-modal__meta{
    font-size:13px;
    color:#374151;
    margin-top:6px;
  }
  .danger-btn{
    border-color:#ef4444 !important;
    color:#b91c1c !important;
  }
</style>

<div class="cal-head">
  <div style="display:flex; align-items:center; gap:12px;">
    {% if month > 1 %}
      <a class="btn-secondary" href="?year={{ year }}&month={{ month|add:"-1" }}&filter={{ filter }}">←</a>
    {% else %}
      <a class="btn-secondary" href="?year={{ year|add:"-1" }}&month=12&filter={{ filter }}">←</a>
    {% endif %}

    <strong style="font-size:18px;">{{ month_name }} {{ year }}</strong>

    {% if month < 12 %}
      <a class="btn-secondary" href="?year={{ year }}&month={{ month|add:"1" }}&filter={{ filter }}">→</a>
    {% else %}
      <a class="btn-secondary" href="?year={{ year|add:"1" }}&month=1&filter={{ filter }}">→</a>
    {% endif %}
  </div>

  <form method="get" style="display:flex; align-items:center; gap:10px;">
    <input type="hidden" name="year" value="{{ year }}">
    <input type="hidden" name="month" value="{{ month }}">

    <label class="muted" for="filter" style="white-space:nowrap;">Фильтр:</label>
    <select id="filter" name="filter" onchange="this.form.submit()">
      <option value="all" {% if filter == "all" %}selected{% endif %}>Все</option>
      <option value="confirmed" {% if filter == "confirmed" %}selected{% endif %}>Только подтверждённые</option>
      <option value="mine" {% if filter == "mine" %}selected{% endif %}>Только мои</option>
    </select>
    <noscript><button class="btn-secondary" type="submit">OK</button></noscript>
  </form>
</div>

<div class="cal-wrap">
  <div class="cal-weekdays">
    <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div>
  </div>

  {% for week in month_days %}
    <div class="cal-week">
      {% for day in week %}
        <div class="cal-day {% if day.month != month %}other-month{% endif %} {% if day|date:'Y-m-d' == today_str %}today{% endif %}" data-day="{{ day|date:'Y-m-d' }}">
          <div class="cal-day-number">{{ day.day }}</div>
        </div>
      {% endfor %}

      <div class="cal-bars">
        {% for seg in week_segments|get_item:week.0 %}
          <div
            class="event-bar status-{{ seg.event.status }} {% if seg.has_problem %}has-problem{% endif %} {% if seg.cont_left %}cont-left{% endif %} {% if seg.cont_right %}cont-right{% endif %}"
            style="--start: {{ seg.start_col }}; --span: {{ seg.span }}; --lane: {{ seg.lane }};"
            draggable="{% if can_create_event %}true{% else %}false{% endif %}"
            data-event-id="{{ seg.event.id }}"
            data-event-name="{{ seg.event.name|escape }}"
            data-start="{{ seg.data_start }}"
            data-end="{{ seg.data_end }}"
            data-status="{{ seg.event.status }}"
            title="{{ seg.event.name }} · {{ seg.event.start_date|date:'d.m.Y' }} – {{ seg.event.end_date|date:'d.m.Y' }} · {{ seg.event.get_status_display }}"
          >
            <a href="{% url 'event_detail' seg.event.id %}">{{ seg.event.name }}</a>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>

<!-- CREATE MODAL -->
<div id="calCreateBackdrop" class="cal-modal-backdrop" aria-hidden="true">
  <div class="cal-modal" role="dialog" aria-modal="true" aria-labelledby="calCreateTitle">
    <div class="cal-modal__head">
      <h3 id="calCreateTitle" class="cal-modal__title">Создать мероприятие</h3>
      <button type="button" class="cal-modal__close" id="calCreateClose" aria-label="Закрыть">✕</button>
    </div>

    <div class="cal-modal__body">
      <div class="muted" style="margin-bottom:10px;">
        Дата выбрана: <strong id="calCreateDateText"></strong>
      </div>

      <div class="cal-modal__row">
        <label>Название</label>
        <input id="calCreateName" type="text" placeholder="Например: Съёмка / выезд / мероприятие">
      </div>

      <div class="cal-modal__row">
        <label>Конец (опц.)</label>
        <input id="calCreateEnd" type="date">
      </div>

      <div id="calCreateError" class="muted" style="margin-top:10px; color:#b00020;"></div>
    </div>

    <div class="cal-modal__actions">
      <button type="button" class="btn-secondary" id="calCreateCancel">Отмена</button>
      <button type="button" class="btn" id="calCreateSave">Создать</button>
    </div>
  </div>
</div>

<!-- PREVIEW MODAL -->
<div id="calPreviewBackdrop" class="cal-modal-backdrop" aria-hidden="true">
  <div class="cal-modal" role="dialog" aria-modal="true" aria-labelledby="calPreviewTitle">
    <div class="cal-modal__head">
      <h3 id="calPreviewTitle" class="cal-modal__title">Мероприятие</h3>
      <button type="button" class="cal-modal__close" id="calPreviewClose" aria-label="Закрыть">✕</button>
    </div>

    <div class="cal-modal__body">
      <div style="font-weight:900; font-size:18px;" id="pvName"></div>
      <div class="cal-modal__meta" id="pvDates"></div>

      <div class="cal-modal__row">
        <label>Статус</label>
        <select id="pvStatus">
          <option value="draft">Черновик</option>
          <option value="confirmed">Подтверждено</option>
          <option value="cancelled">Отменено</option>
          <option value="closed">Закрыто</option>
        </select>
      </div>

      <div id="pvError" class="muted" style="margin-top:10px; color:#b00020;"></div>
    </div>

    <div class="cal-modal__actions">
      <a id="pvOpen" class="btn-secondary" href="#">Открыть карточку</a>
      <a id="pvEdit" class="btn-secondary" href="#">Редактировать</a>
      <button type="button" class="btn" id="pvSetStatus">Сохранить статус</button>
      <button type="button" class="btn btn-secondary danger-btn" id="pvDelete">Удалить</button>
    </div>
  </div>
</div>

<script>
(function(){
  const canCreate = {{ can_create_event|yesno:"true,false" }};

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return "";
  }
  const csrftoken = getCookie("csrftoken");

  // ---- AUTO HEIGHT: set lanes per week (so nothing gets cut) ----
  function autoWeekHeights(){
    document.querySelectorAll(".cal-week").forEach(week => {
      const bars = Array.from(week.querySelectorAll(".event-bar"));
      let maxLane = -1;
      bars.forEach(b => {
        const lane = parseInt(getComputedStyle(b).getPropertyValue("--lane")) || 0;
        if (lane > maxLane) maxLane = lane;
      });

      const lanes = Math.max(1, maxLane + 1);
      week.style.setProperty("--lanes", String(lanes));

      const extra = Math.max(0, lanes - 3) * 26;
      week.querySelectorAll(".cal-day").forEach(d => {
        d.style.minHeight = String(120 + extra) + "px";
      });
    });
  }
  window.requestAnimationFrame(autoWeekHeights);

  // ===== Create modal =====
  const createBackdrop = document.getElementById("calCreateBackdrop");
  const createCloseBtn = document.getElementById("calCreateClose");
  const createCancelBtn = document.getElementById("calCreateCancel");
  const createSaveBtn = document.getElementById("calCreateSave");
  const createDateText = document.getElementById("calCreateDateText");
  const createNameInput = document.getElementById("calCreateName");
  const createEndInput = document.getElementById("calCreateEnd");
  const createErrBox = document.getElementById("calCreateError");
  let selectedDay = null;

  function openCreate(dayStr){
    selectedDay = dayStr;
    createDateText.textContent = dayStr;
    createEndInput.value = dayStr;
    createNameInput.value = "";
    createErrBox.textContent = "";
    createBackdrop.style.display = "flex";
    createBackdrop.setAttribute("aria-hidden","false");
    setTimeout(()=>createNameInput.focus(), 50);
  }
  function closeCreate(){
    createBackdrop.style.display = "none";
    createBackdrop.setAttribute("aria-hidden","true");
    selectedDay = null;
  }

  createBackdrop.addEventListener("click", (e)=>{ if(e.target===createBackdrop) closeCreate(); });
  createCloseBtn.addEventListener("click", closeCreate);
  createCancelBtn.addEventListener("click", closeCreate);

  // click on empty day -> create
  document.addEventListener("click", function(e){
    const cell = e.target.closest(".cal-day");
    if(!cell) return;
    if(e.target.closest(".event-bar")) return;
    if(cell.classList.contains("other-month")) return;
    if(!canCreate) return;

    const dayStr = cell.getAttribute("data-day");
    if(!dayStr) return;
    openCreate(dayStr);
  });

  createSaveBtn.addEventListener("click", async function(){
    if(!selectedDay) return;
    const name = (createNameInput.value || "").trim();
    const end = (createEndInput.value || "").trim() || selectedDay;

    createErrBox.textContent = "";
    if(!name){
      createErrBox.textContent = "Название обязательно.";
      return;
    }

    createSaveBtn.disabled = true;

    try{
      const resp = await fetch("{% url 'quick_create_event_api' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({
          name: name,
          start_date: selectedDay,
          end_date: end,
        }),
      });

      const data = await resp.json();
      if(!data.ok){
        createErrBox.textContent = data.error || "Ошибка создания";
        createSaveBtn.disabled = false;
        return;
      }

      window.location.reload();
    }catch(err){
      createErrBox.textContent = "Ошибка сети / сервера";
      createSaveBtn.disabled = false;
    }
  });

  document.addEventListener("keydown", function(e){
    if(e.key === "Escape"){
      if(createBackdrop.style.display === "flex") closeCreate();
      if(previewBackdrop.style.display === "flex") closePreview();
    }
  });

  // ===== Preview modal =====
  const previewBackdrop = document.getElementById("calPreviewBackdrop");
  const pvClose = document.getElementById("calPreviewClose");
  const pvName = document.getElementById("pvName");
  const pvDates = document.getElementById("pvDates");
  const pvStatus = document.getElementById("pvStatus");
  const pvSetStatus = document.getElementById("pvSetStatus");
  const pvOpen = document.getElementById("pvOpen");
  const pvEdit = document.getElementById("pvEdit");
  const pvDelete = document.getElementById("pvDelete");
  const pvError = document.getElementById("pvError");

  let pvEventId = null;

  function openPreview(data){
    pvEventId = data.id;
    pvName.textContent = data.name;
    pvDates.textContent = data.dates;
    pvStatus.value = data.status;

    pvOpen.href = data.openUrl;
    pvEdit.href = data.editUrl;

    pvError.textContent = "";
    previewBackdrop.style.display = "flex";
    previewBackdrop.setAttribute("aria-hidden","false");
  }
  function closePreview(){
    previewBackdrop.style.display = "none";
    previewBackdrop.setAttribute("aria-hidden","true");
    pvEventId = null;
  }

  previewBackdrop.addEventListener("click", (e)=>{ if(e.target===previewBackdrop) closePreview(); });
  pvClose.addEventListener("click", closePreview);

  // click on event -> preview (do not navigate)
  document.addEventListener("click", function(e){
    const bar = e.target.closest(".event-bar");
    if(!bar) return;

    // allow Ctrl/Cmd click to open in new tab
    if (e.ctrlKey || e.metaKey) return;

    e.preventDefault();

    const id = bar.getAttribute("data-event-id");
    const name = bar.getAttribute("data-event-name") || "";
    const start = bar.getAttribute("data-start");
    const end = bar.getAttribute("data-end");
    const status = bar.getAttribute("data-status") || "draft";

    const dates = `${start} → ${end}`;

    const openUrl = `{% url 'event_detail' 0 %}`.replace("/0/", `/${id}/`);
    const editUrl = `{% url 'event_edit' 0 %}`.replace("/0/", `/${id}/`);

    openPreview({id, name, dates, status, openUrl, editUrl});
  });

  pvSetStatus.addEventListener("click", async function(){
    if(!pvEventId) return;
    pvError.textContent = "";

    // status endpoint is simple GET redirect - we'll just navigate (safe)
    const newStatus = pvStatus.value;
    const url = `{% url 'event_set_status' 0 'draft' %}`.replace("/0/", `/${pvEventId}/`).replace("/draft/", `/${newStatus}/`);
    window.location.href = url;
  });

  pvDelete.addEventListener("click", async function(){
    if(!pvEventId) return;
    pvError.textContent = "";

    if(!confirm("Удалить мероприятие? Оно попадёт в архив и будет очищено через 30 дней.")) return;

    try{
      const url = `{% url 'event_delete' 0 %}`.replace("/0/", `/${pvEventId}/`);
      const resp = await fetch(url, {
        method: "POST",
        headers: {"X-CSRFToken": csrftoken},
      });
      if(!resp.ok){
        pvError.textContent = "Не удалось удалить.";
        return;
      }
      window.location.reload();
    }catch(err){
      pvError.textContent = "Ошибка сети / сервера";
    }
  });

  // ===== Drag & drop move =====
  let draggingEl = null;

  document.addEventListener("dragstart", function(e){
    const ev = e.target.closest(".event-bar");
    if(!ev) return;
    if(!canCreate) return;

    draggingEl = ev;
    ev.classList.add("dragging");

    e.dataTransfer.effectAllowed = "move";
    e.dataTransfer.setData("text/plain", JSON.stringify({
      event_id: ev.getAttribute("data-event-id"),
      start: ev.getAttribute("data-start"),
      end: ev.getAttribute("data-end"),
    }));
  });

  document.addEventListener("dragend", function(e){
    if(draggingEl) draggingEl.classList.remove("dragging");
    draggingEl = null;
    document.querySelectorAll(".cal-day.drop-hover").forEach(x=>x.classList.remove("drop-hover"));
  });

  document.addEventListener("dragover", function(e){
    const cell = e.target.closest(".cal-day");
    if(!cell) return;
    if(cell.classList.contains("other-month")) return;
    if(!canCreate) return;

    e.preventDefault();
    cell.classList.add("drop-hover");
  });

  document.addEventListener("dragleave", function(e){
    const cell = e.target.closest(".cal-day");
    if(!cell) return;
    cell.classList.remove("drop-hover");
  });

  document.addEventListener("drop", async function(e){
    const cell = e.target.closest(".cal-day");
    if(!cell) return;
    if(cell.classList.contains("other-month")) return;
    if(!canCreate) return;

    e.preventDefault();
    cell.classList.remove("drop-hover");

    let payload = null;
    try{
      payload = JSON.parse(e.dataTransfer.getData("text/plain") || "{}");
    }catch(err){
      return;
    }
    if(!payload || !payload.event_id) return;

    const newStart = cell.getAttribute("data-day");
    if(!newStart) return;

    try{
      const url = `{% url 'quick_move_event_api' 0 %}`.replace("/0/", `/${payload.event_id}/`);
      const resp = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({ new_start_date: newStart }),
      });

      const data = await resp.json();
      if(!data.ok){
        alert(data.error || "Не удалось переместить");
        return;
      }
      window.location.reload();
    }catch(err){
      alert("Ошибка сети / сервера");
    }
  });

})();
</script>

{% endblock %}
