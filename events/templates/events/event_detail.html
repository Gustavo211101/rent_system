{% extends "base.html" %}

{% block content %}
<div class="page-head">
  <div>
    <h1 style="margin:0;">{{ event.name }}</h1>

    <div class="muted" style="margin-top:8px;">
      <div><strong>Дата:</strong>
        {% if event.start_date == event.end_date %}
          {{ event.start_date|date:"d.m.Y" }}
        {% else %}
          {{ event.start_date|date:"d.m.Y" }} – {{ event.end_date|date:"d.m.Y" }}
        {% endif %}
      </div>
      <div style="margin-top:4px;"><strong>Клиент:</strong> {{ event.client|default:"—" }}</div>
      <div style="margin-top:4px;"><strong>Локация:</strong> {{ event.location|default:"—" }}</div>

      <div style="margin-top:8px;">
        <strong>Заметки:</strong>
        {% if event.notes %}
          <div style="margin-top:6px; white-space:pre-wrap;">{{ event.notes }}</div>
        {% else %}
          <span class="muted">—</span>
        {% endif %}
      </div>
      <div style="margin-top:4px;"><strong>Ответственный:</strong> {{ event.responsible|default:"—" }}</div>
      <div style="margin-top:4px;"><strong>Старший инженер:</strong> {{ event.s_engineer|default:"—" }}</div>
      <div style="margin-top:4px;"><strong>Инженеры:</strong>
        {% with engs=event.engineers.all %}
          {% if engs %}
            {% for u in engs %}{{ u }}{% if not forloop.last %}, {% endif %}{% endfor %}
          {% else %}
            —
          {% endif %}
        {% endwith %}
      </div>
    </div>

    <div style="margin-top:10px;">
      <strong>Статус:</strong>
      <span class="status-pill status-{{ event.status }}">{{ event.get_status_display }}</span>
    </div>
  </div>

  <div class="page-actions">
    {% if can_modify %}
      <a class="btn-secondary" href="{% url 'event_edit' event.id %}">✏️ Редактировать</a>

      <div style="height:10px;"></div>

      {# Статусные кнопки #}
      {% if event.status != 'draft' %}
        <a class="btn-secondary" href="{% url 'event_set_status' event.id 'draft' %}">В черновик</a>
      {% endif %}

      {% if event.status != 'confirmed' %}
        <a class="btn-secondary" href="{% url 'event_set_status' event.id 'confirmed' %}">Подтвердить</a>
      {% endif %}

      {% if event.status != 'cancelled' %}
        <a class="btn-secondary" href="{% url 'event_set_status' event.id 'cancelled' %}">Отменить</a>
      {% endif %}

      {% if event.status != 'closed' %}
        <a class="btn-secondary" href="{% url 'event_set_status' event.id 'closed' %}">Закрыть</a>
      {% endif %}
    {% endif %}
  </div>
</div>

{# Нехватка оборудования #}
{% if shortages %}
  <div class="alert alert-warning" style="margin-top:18px;">
    <strong>⚠️ Нехватка оборудования</strong>
    <div style="margin-top:8px;">
      {% for row in shortages %}
        <div style="margin-top:4px;">
          {{ row.equipment.name }}: нужно {{ row.required }},
          своё доступно {{ row.available_own }},
          в аренде {{ row.rented }},
          <strong>не хватает {{ row.shortage }}</strong>
        </div>
      {% endfor %}
    </div>

    {% if can_edit_equipment %}
      <div style="margin-top:10px;">
        <a class="btn-secondary" href="{% url 'event_rented_add' event.id %}">➕ Добавить аренду (покрыть нехватку)</a>
      </div>
    {% endif %}
  </div>
{% endif %}

<div class="card" style="margin-top:18px;">
  <h2 style="margin-top:0;">Оборудование (нужно на мероприятие)</h2>

  {% if equipment_items %}
    <table class="list-table">
      <thead>
        <tr>
          <th>Оборудование</th>
          <th style="width: 220px;">Количество</th>
          {% if can_edit_equipment %}
            <th style="width: 220px;">Действия</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for item in equipment_items %}
          <tr>
            <td>{{ item.equipment.name }}</td>
            <td>
              {% if can_edit_equipment %}
                <form method="post" action="{% url 'event_equipment_update_qty' event.id item.id %}" style="display:flex; gap:8px; align-items:center;">
                  {% csrf_token %}
                  <input type="number" name="quantity" value="{{ item.quantity }}" min="0" style="width:90px;">
                  <button class="btn-secondary" type="submit">Сохранить</button>
                </form>
                <small class="muted">0 = удалить</small>
              {% else %}
                {{ item.quantity }}
              {% endif %}
            </td>

            {% if can_edit_equipment %}
              <td>
                <form method="post" action="{% url 'event_equipment_delete' event.id item.id %}">
                  {% csrf_token %}
                  <button class="btn-secondary" type="submit">Удалить</button>
                </form>
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="muted">Пока ничего не добавлено.</div>
  {% endif %}

  {% if can_edit_equipment %}
    <div style="margin-top:12px;">
      <a class="btn" href="{% url 'event_equipment_add' event.id %}">➕ Добавить оборудование</a>
    </div>
  {% endif %}
</div>

<div class="card" style="margin-top:18px;">
  <h2 style="margin-top:0;">Взято в аренду (покрывает нехватку)</h2>

  {% if rented_items %}
    <table class="list-table">
      <thead>
        <tr>
          <th>Оборудование</th>
          <th style="width: 220px;">Количество</th>
          {% if can_edit_equipment %}
            <th style="width: 220px;">Действия</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for item in rented_items %}
          <tr>
            <td>{{ item.equipment.name }}</td>
            <td>
              {% if can_edit_equipment %}
                <form method="post" action="{% url 'event_rented_update_qty' event.id item.id %}" style="display:flex; gap:8px; align-items:center;">
                  {% csrf_token %}
                  <input type="number" name="quantity" value="{{ item.quantity }}" min="0" style="width:90px;">
                  <button class="btn-secondary" type="submit">Сохранить</button>
                </form>
                <small class="muted">0 = удалить</small>
              {% else %}
                {{ item.quantity }}
              {% endif %}
            </td>

            {% if can_edit_equipment %}
              <td>
                <form method="post" action="{% url 'event_rented_delete' event.id item.id %}">
                  {% csrf_token %}
                  <button class="btn-secondary" type="submit">Удалить</button>
                </form>
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="muted">Пока ничего не арендовано.</div>
  {% endif %}

  {% if can_edit_equipment %}
    <div style="margin-top:12px;">
      <a class="btn" href="{% url 'event_rented_add' event.id %}">➕ Добавить аренду</a>
    </div>
  {% endif %}
</div>
{% endblock %}
