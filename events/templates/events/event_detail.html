{% extends "base.html" %}
{% load event_extras %}

{% block content %}
<div class="page-head">
  <div>
    <h1 style="margin:0;">{{ event.name }}</h1>

    <div class="muted" style="margin-top:8px;">
      <div><strong>–î–∞—Ç–∞:</strong>
        {% if event.start_date == event.end_date %}
          {{ event.start_date|date:"d.m.Y" }}
        {% else %}
          {{ event.start_date|date:"d.m.Y" }} ‚Äì {{ event.end_date|date:"d.m.Y" }}
        {% endif %}
      </div>
      <div style="margin-top:4px;"><strong>–ö–ª–∏–µ–Ω—Ç:</strong> {{ event.client|default:"‚Äî" }}</div>
      <div style="margin-top:4px;"><strong>–õ–æ–∫–∞—Ü–∏—è:</strong> {{ event.location|default:"‚Äî" }}</div>

      <div style="margin-top:8px;"><strong>–ó–∞–º–µ—Ç–∫–∏:</strong>
        {% if event.notes %}
          <div style="margin-top:6px; white-space:pre-wrap;">{{ event.notes }}</div>
        {% else %}
          <span class="muted">‚Äî</span>
        {% endif %}
      </div>

      <div style="margin-top:4px;"><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong>
        {{ event.responsible.get_full_name|default:event.responsible.username }}
      </div>

      <div style="margin-top:4px;"><strong>–°—Ç–∞—Ä—à–∏–π –∏–Ω–∂–µ–Ω–µ—Ä:</strong>
        {% if event.s_engineer %}
          {{ event.s_engineer.get_full_name|default:event.s_engineer.username }}
        {% else %}
          ‚Äî
        {% endif %}
      </div>

      <div style="margin-top:4px;"><strong>–ò–Ω–∂–µ–Ω–µ—Ä—ã:</strong>
        {% if event.engineers.all %}
          {% for u in event.engineers.all %}
            {{ u.get_full_name|default:u.username }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        {% else %}
          ‚Äî
        {% endif %}
      </div>

      <div style="margin-top:6px;">
        <strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏:</strong>
        {% if event.role_slots.all %}
          <div style="margin-top:6px;">
            {% for slot in event.role_slots.all %}
              <div style="margin-top:4px;">
                <strong>{{ slot.role.name }}:</strong>
                {% if slot.users.all %}
                  {% for user in slot.users.all %}
                    {{ user.get_full_name|default:user.username }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                {% else %}
                  ‚Äî
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          ‚Äî
        {% endif %}
      </div>
    </div>

    <div style="margin-top:10px;">
      <strong>–°—Ç–∞—Ç—É—Å:</strong>
      <span class="status-pill status-{{ event.status }}">{{ event.get_status_display }}</span>
    </div>
  </div>

  <div class="page-actions">
    {% with y=request.GET.year m=request.GET.month %}
      <a class="btn-secondary" href="{% url 'calendar' %}{% if y and m %}?year={{ y }}&month={{ m }}{% endif %}">‚Üê –ù–∞–∑–∞–¥ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å</a>
    {% endwith %}

    {% if can_modify %}
      <a class="btn-secondary" href="{% url 'event_edit' event.id %}{% if request.GET.year and request.GET.month %}?year={{ request.GET.year }}&month={{ request.GET.month }}{% endif %}">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>

      <div style="height:10px;"></div>

      {% if event.allowed_next_statuses %}
      {% for st in event.allowed_next_statuses %}
        <a class="btn-secondary" href="{% url 'event_set_status' event.id st %}">{{ st|status_label }}</a>
      {% endfor %}
      {% if event.status != 'closed' %}
        {# –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –≤—Å–µ–≥–¥–∞ —è–≤–ª—è—é—Ç—Å—è ‚Äú—Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º‚Äù #}
      {% endif %}
    {% endif %}
    {% endif %}
  </div>
</div>

{% if stock_shortages %}
  <div class="alert alert-warning" style="margin-top:18px;">
    <strong>‚ö†Ô∏è –ù–µ—Ö–≤–∞—Ç–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (—Å–∫–ª–∞–¥, –±—Ä–æ–Ω—å)</strong>
    <div style="margin-top:8px;">
      {% for row in stock_shortages %}
        <div style="margin-top:4px;">
          {{ row.type.name }}: –Ω—É–∂–Ω–æ {{ row.required }}, –¥–æ—Å—Ç—É–ø–Ω–æ {{ row.available }},
          <strong>–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç {{ row.shortage }}</strong>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}

<div class="card" style="margin-top:18px;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <h2 style="margin:0;">–°–∫–ª–∞–¥</h2>

    {% if can_edit_equipment %}
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn" href="{% url 'event_stock_add' event.id %}">‚ûï –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–æ —Å–∫–ª–∞–¥–∞</a>
        <a class="btn-secondary" href="{% url 'event_stock_load' event.id %}">üöö –ü–æ–≥—Ä—É–∑–∫–∞ (—Å–∫–∞–Ω–µ—Ä)</a>
      </div>
    {% endif %}
  </div>

  <div style="margin-top:16px;"></div>

  {% if stock_rows %}
    <table class="list-table">
      <thead>
        <tr>
          <th>–¢–∏–ø</th>
          <th style="width:200px;">–ë—Ä–æ–Ω—å</th>
          <th style="width:220px;">–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</th>
          <th style="width:220px;">–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –¥–∞—Ç—ã</th>
          {% if can_edit_equipment %}
            <th style="width:260px;">–î–µ–π—Å—Ç–≤–∏—è</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for row in stock_rows %}
          <tr>
            <td>
              <div><strong>{{ row.reservation.equipment_type.name }}</strong></div>
              <div class="muted" style="margin-top:2px;">
                {{ row.reservation.equipment_type.category.name }}
                {% if row.reservation.equipment_type.subcategory %} / {{ row.reservation.equipment_type.subcategory.name }}{% endif %}
              </div>
            </td>

            <td>
              {% if can_edit_equipment %}
                <form method="post" action="{% url 'event_stock_update_qty' event.id row.reservation.id %}" style="display:flex; gap:8px; align-items:center;">
                  {% csrf_token %}
                  <input type="number" name="quantity" value="{{ row.reservation.quantity }}" min="0" style="width:90px;">
                  <button class="btn-secondary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
                <small class="muted">0 = —É–¥–∞–ª–∏—Ç—å –±—Ä–æ–Ω—å</small>
              {% else %}
                {{ row.reservation.quantity }}
              {% endif %}
            </td>

            <td>
              <div>
                <strong>{{ row.issued|default:0 }}</strong> / {{ row.reservation.quantity }}
              </div>
              {% if row.issued and row.issued|add:0 >= row.reservation.quantity %}
                <div class="muted" style="margin-top:2px;">‚úÖ –ü–ª–∞–Ω –∑–∞–∫—Ä—ã—Ç</div>
              {% else %}
                <div class="muted" style="margin-top:2px;">–û—Å—Ç–∞–ª–æ—Å—å: {{ row.remaining }}</div>
              {% endif %}
            </td>

            <td>
              {{ row.available }}
              {% if row.shortage > 0 %}
                <div class="muted" style="margin-top:2px; color:#b05;">
                  ‚ö† –Ω–µ—Ö–≤–∞—Ç–∫–∞ {{ row.shortage }}
                </div>
              {% endif %}
            </td>

            {% if can_edit_equipment %}
              <td>
                <form method="post" action="{% url 'event_stock_delete' event.id row.reservation.id %}" style="display:inline;">
                  {% csrf_token %}
                  <button class="btn-secondary" type="submit">–£–¥–∞–ª–∏—Ç—å –±—Ä–æ–Ω—å</button>
                </form>
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if issued_items %}
      <div style="margin-top:16px;">
        <strong>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (—Ñ–∞–∑–∞ 2):</strong>
        <div class="muted" style="margin-top:6px;">
          {% for iss in issued_items|slice:":10" %}
            <div style="margin-top:2px;">‚Ä¢ {{ iss.item.inventory_number }} ‚Äî {{ iss.item.equipment_type.name }}</div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

  {% else %}
    <div class="muted" style="margin-top:10px;">–ü–æ–∫–∞ –Ω–µ—Ç –±—Ä–æ–Ω–µ–π. –î–æ–±–∞–≤—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ —Å–∫–ª–∞–¥–∞.</div>
  {% endif %}
</div>

{% endblock %}