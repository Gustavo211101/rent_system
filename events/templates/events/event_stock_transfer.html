{% extends "base.html" %}

{% block content %}
  <h1>‚áÑ –ü–µ—Ä–µ–≤—ã–¥–∞—á–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h1>

  <div style="margin: 12px 0; display:flex; gap:8px; flex-wrap: wrap;">
    <a class="btn-secondary" href="{% url 'event_detail' event.id %}">‚Üê –ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é</a>
    <a class="btn-secondary" href="{% url 'event_stock_load' event.id %}">üöö –ü–æ–≥—Ä—É–∑–∫–∞</a>
    <a class="btn-secondary" href="{% url 'event_stock_return' event.id %}">‚Ü© –í–æ–∑–≤—Ä–∞—Ç</a>
  </div>

  {% if result_message %}
    <div class="alert {% if result_success %}alert-success{% else %}alert-danger{% endif %}" style="margin: 12px 0;">
      {{ result_message }}
    </div>
  {% endif %}

  <div style="margin: 16px 0; padding: 12px; border: 1px solid #eee; border-radius: 8px;">
    <form method="get" style="display:flex; gap:10px; align-items: center; flex-wrap: wrap;">
      <label for="q"><b>–ù–∞–π—Ç–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</b></label>
      <input id="q" name="q" type="text" value="{{ q|default:'' }}" placeholder="–Ω–∞–∑–≤–∞–Ω–∏–µ / –∫–ª–∏–µ–Ω—Ç / –ª–æ–∫–∞—Ü–∏—è / ID" style="width: 360px;" />
      {% if target_event_id %}<input type="hidden" name="target" value="{{ target_event_id }}">{% endif %}
      <button class="btn-secondary" type="submit">–ù–∞–π—Ç–∏</button>
      {% if q %}
        <a class="btn-secondary" href="?">–°–±—Ä–æ—Å–∏—Ç—å</a>
      {% endif %}
    </form>

    <div style="margin-top: 12px;">
      <b>–¶–µ–ª–µ–≤–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</b>
      {% if target_events %}
        <div style="margin-top: 8px; display:flex; flex-direction: column; gap:6px;">
          {% for e in target_events %}
            {% if e.status == 'closed' %}
    <label style="display:flex; gap:10px; align-items:center; opacity:0.55;">
        <input type="radio" disabled>
        <span>
            #{{ e.id }} ‚Äî {{ e.name }} ({{ e.start_date|date:"d.m.Y" }}) ‚Äî {{ e.status }}
        </span>
        <span style="color:#c00;">–Ω–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å</span>
    </label>
{% else %}
    <label style="display:flex; gap:10px; align-items:center;">
        <input type="radio"
               name="target_pick"
               onclick="document.getElementById('target_event_id').value='{{ e.id }}'">
        <span>
            #{{ e.id }} ‚Äî {{ e.name }} ({{ e.start_date|date:"d.m.Y" }}) ‚Äî {{ e.status }}
        </span>
    </label>
{% endif %}
          {% endfor %}
        </div>
      {% else %}
        <div style="margin-top: 8px; opacity: 0.7;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>
      {% endif %}
    </div>
  </div>

  <form method="post" style="margin: 16px 0;">
    {% csrf_token %}

    <input id="target_event_id" name="target_event_id" type="hidden" value="{{ target_event_id|default:'' }}" />

    <div style="margin-bottom: 10px; display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
      <div><b>–í—ã–±—Ä–∞–Ω–æ:</b>
        {% if target_event %}
          <span style="padding:2px 6px; border:1px solid #eee; border-radius: 6px;">
            #{{ target_event.id }} ‚Äî {{ target_event.name }}
          </span>
        {% elif target_event_id %}
          <span style="padding:2px 6px; border:1px solid #eee; border-radius: 6px;">ID {{ target_event_id }}</span>
        {% else %}
          <span style="opacity:0.7;">–Ω–µ –≤—ã–±—Ä–∞–Ω–æ</span>
        {% endif %}
      </div>

      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <label for="target_event_id_manual" style="opacity:0.7;">–∏–ª–∏ ID –≤—Ä—É—á–Ω—É—é</label>
        <input id="target_event_id_manual" type="number" min="1" style="width: 120px;"
               oninput="document.getElementById('target_event_id').value=this.value;" placeholder="ID" />
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
      <label for="inventory_number"><b>–°–∫–∞–Ω–∏—Ä—É–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä–Ω–∏–∫</b></label>
      <input id="inventory_number" name="inventory_number" type="text" autofocus autocomplete="off" style="width: 320px;" />
      <button class="btn-primary" type="submit">–ü–µ—Ä–µ–≤—ã–¥–∞—Ç—å</button>
    </div>
  </form>

  <div style="margin-top: 18px;"></div>

  <h3>–°–µ–π—á–∞—Å –≤—ã–¥–∞–Ω–æ –∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ ({{ open_issues|length }})</h3>
  {% if open_issues %}
    <table class="list-table" style="margin-top: 10px;">
      <thead>
        <tr>
          <th>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω–∏–∫</th>
          <th>–¢–∏–ø</th>
          <th>–í—ã–¥–∞–Ω–æ</th>
        </tr>
      </thead>
      <tbody>
        {% for issue in open_issues %}
          <tr>
            <td>
              <a href="{% url 'stock_item_card' issue.item.equipment_type_id issue.item.id %}">{{ issue.item.inventory_number }}</a>
            </td>
            <td>{{ issue.item.equipment_type.name }}</td>
            <td>{{ issue.issued_at|date:"d.m.Y H:i" }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div style="opacity:0.7; margin-top: 8px;">–ù–µ—Ç –Ω–µ–≤–æ–∑–≤—Ä–∞—â—ë–Ω–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü.</div>
  {% endif %}
{% endblock %}
